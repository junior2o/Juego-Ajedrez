var ye=Object.defineProperty;var fe=(s,e,t)=>e in s?ye(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var b=(s,e,t)=>fe(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();const D=class D{constructor(){b(this,"socket",null);b(this,"callbacks",{});b(this,"messageQueue",[]);b(this,"isConnected",!1)}static getInstance(){return D.instance||(D.instance=new D),D.instance}connect(e){this.socket=new WebSocket(e),this.socket.onopen=()=>{console.log("[WebSocket] Connected"),this.isConnected=!0;const t=localStorage.getItem("playerId")||"",o={type:"init_with_id",id:t};for(this.send(o),console.log("[WebSocket] Sent init_with_id:",t);this.messageQueue.length>0;){const n=this.messageQueue.shift();n&&this.send(n)}},this.socket.onmessage=t=>{try{const o=JSON.parse(t.data);this.dispatchMessage(o)}catch{console.error("[WebSocket] Invalid message received:",t.data)}},this.socket.onclose=()=>{console.warn("[WebSocket] Disconnected"),this.isConnected=!1},this.socket.onerror=t=>{console.error("[WebSocket] Error:",t)}}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.isConnected?this.socket.send(JSON.stringify(e)):(console.warn("[WebSocket] Not ready, message enqueued."),this.messageQueue.push(e))}on(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}off(e,t){const o=this.callbacks[e];o&&(this.callbacks[e]=o.filter(n=>n!==t))}dispatchMessage(e){const t=e.type;console.log("[WebSocket] dispatchMessage",t);const o=this.callbacks[t];o&&o.length>0?o.forEach(n=>n(e)):t in this.callbacks||console.warn("[WebSocket] Unhandled message type:",t,e)}};b(D,"instance");let A=D;const q=class q{constructor(){b(this,"localId","esperando");b(this,"opponentId",null);b(this,"matchId",null)}static getInstance(){return q.instance||(q.instance=new q),q.instance}setLocalId(e){this.localId=e;const t=document.getElementById("local-id-display");t&&(t.textContent=`Tu ID: ${e}`)}getLocalId(){return this.localId}setOpponentId(e){this.opponentId=e}getOpponentId(){return this.opponentId}setMatchId(e){this.matchId=e}getMatchId(){return this.matchId}reset(){this.opponentId=null,this.matchId=null}};b(q,"instance");let x=q;function we(s){const e=document.getElementById("app");e.innerHTML="";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.height="100vh",t.style.gap="20px";const o=document.createElement("h2");o.textContent=`Invitación de: ${s.fromId}`,t.appendChild(o);const n=document.createElement("button");n.textContent="Aceptar",n.style.padding="10px 20px",n.style.fontSize="16px",n.style.cursor="pointer";const a=document.createElement("button");a.textContent="Rechazar",a.style.padding="10px 20px",a.style.fontSize="16px",a.style.cursor="pointer",n.onclick=()=>{const i=x.getInstance().getLocalId();x.getInstance().setOpponentId(s.fromId);const p={type:"join_response",accepted:!0,fromId:i,toId:s.fromId};A.getInstance().send(p)},a.onclick=()=>{const i={type:"join_response",accepted:!1,fromId:x.getInstance().getLocalId(),toId:s.fromId};A.getInstance().send(i),e.innerHTML="<p>Has rechazado la invitación.</p>"},t.appendChild(n),t.appendChild(a),e.appendChild(t)}let be=1e3;function ke(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`piece_${be++}`}function Q(s){return s.map(e=>e.map(t=>t?{...t}:null))}class F{constructor(e){b(this,"board");b(this,"currentTurn");b(this,"hasMoved",{});b(this,"enPassantTarget",null);b(this,"moveHistory",[]);this.board=Q(e),this.currentTurn="white"}clone(){const e=new F(Q(this.board));return e.currentTurn=this.currentTurn,e.hasMoved={...this.hasMoved},e.enPassantTarget=this.enPassantTarget?{...this.enPassantTarget}:null,e.moveHistory=[...this.moveHistory],e}isInCheck(e){let t=null;for(let n=0;n<8;n++){for(let a=0;a<8;a++){const i=this.board[n][a];if((i==null?void 0:i.type)==="king"&&i.color===e){t={row:n,col:a};break}}if(t)break}if(!t)return!1;const o=e==="white"?"black":"white";for(let n=0;n<8;n++)for(let a=0;a<8;a++){const i=this.board[n][a];if(i&&i.color===o&&this.getRawMoves({row:n,col:a},!0).some(u=>u.row===t.row&&u.col===t.col))return!0}return!1}getBoard(){return Q(this.board)}getCurrentTurn(){return this.currentTurn}getMoveHistory(){return[...this.moveHistory]}makeMove(e,t){return!this.board[e.row][e.col]||!this.getLegalMoves(e).some(i=>i.row===t.row&&i.col===t.col)?!1:(this.applyMove(e,t),!0)}applyMove(e,t){const o=this.board[e.row][e.col];if(this.hasMoved[o.id]=!0,this.moveHistory.push({from:{...e},to:{...t}}),o.type==="pawn"&&this.enPassantTarget&&t.row===this.enPassantTarget.row&&t.col===this.enPassantTarget.col){const a=o.color==="white"?1:-1;this.board[t.row+a][t.col]=null}if(o.type==="king"&&Math.abs(t.col-e.col)===2){const a=e.row;t.col===6?(this.board[a][5]=this.board[a][7],this.board[a][7]=null):t.col===2&&(this.board[a][3]=this.board[a][0],this.board[a][0]=null)}this.board[t.row][t.col]=o,this.board[e.row][e.col]=null,this.currentTurn=this.currentTurn==="white"?"black":"white",o.type==="pawn"&&Math.abs(t.row-e.row)===2?this.enPassantTarget={row:(e.row+t.row)/2,col:e.col}:this.enPassantTarget=null;const n=o.color==="white"?0:7;o.type==="pawn"&&t.row===n&&(this.board[t.row][t.col]={id:ke(),type:"queen",color:o.color,image:`${o.color}_queen.png`,dragImage:`${o.color}_queen_drag.png`})}getLegalMoves(e){var l,h,y,d;const t=this.board[e.row][e.col];if(!t)return[];const o=t.color,n=[],a=(r,g)=>{if(r>=0&&r<8&&g>=0&&g<8){const m=this.board[r][g];(!m||m.color!==o)&&n.push({row:r,col:g})}};if(t.type==="pawn"){const r=o==="white"?-1:1,g=o==="white"?6:1,m=e.row+r,f=e.row+r*2;((l=this.board[m])==null?void 0:l[e.col])===null&&(n.push({row:m,col:e.col}),e.row===g&&((h=this.board[f])==null?void 0:h[e.col])===null&&n.push({row:f,col:e.col}));for(const k of[-1,1]){const I=e.col+k,E=e.row+r;if(I>=0&&I<8){const W=(y=this.board[E])==null?void 0:y[I];W&&W.color!==o&&n.push({row:E,col:I}),((d=this.enPassantTarget)==null?void 0:d.row)===E&&this.enPassantTarget.col===I&&n.push({row:E,col:I})}}}t.type==="knight"&&[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([r,g])=>a(e.row+r,e.col+g));const i=[[-1,-1],[-1,1],[1,-1],[1,1]],p=[[-1,0],[1,0],[0,-1],[0,1]],u=[...i,...p],c=[];t.type==="bishop"&&c.push(...i),t.type==="rook"&&c.push(...p),t.type==="queen"&&c.push(...u);for(const[r,g]of c){let m=e.row+r,f=e.col+g;for(;m>=0&&m<8&&f>=0&&f<8;){const k=this.board[m][f];if(!k)n.push({row:m,col:f});else{k.color!==o&&n.push({row:m,col:f});break}m+=r,f+=g}}if(t.type==="king"){for(const[r,g]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])a(e.row+r,e.col+g);if(!this.hasMoved[t.id]&&!this.isInCheck(o)){const r=e.row,g=this.board[r][7];g&&g.type==="rook"&&g.color===o&&!this.hasMoved[g.id]&&this.board[r][5]===null&&this.board[r][6]===null&&!this.isAttacked({row:r,col:5},o)&&!this.isAttacked({row:r,col:6},o)&&n.push({row:r,col:6});const m=this.board[r][0];m&&m.type==="rook"&&m.color===o&&!this.hasMoved[m.id]&&this.board[r][1]===null&&this.board[r][2]===null&&this.board[r][3]===null&&!this.isAttacked({row:r,col:2},o)&&!this.isAttacked({row:r,col:3},o)&&n.push({row:r,col:2})}}return n.filter(r=>{const g=this.clone();return g.applyMove(e,r),!g.isInCheck(o)})}hasAnyLegalMove(e){for(let t=0;t<8;t++)for(let o=0;o<8;o++){const n=this.board[t][o];if((n==null?void 0:n.color)===e&&this.getLegalMoves({row:t,col:o}).length>0)return!0}return!1}getRawMoves(e,t=!1){var h,y;const o=this.board[e.row][e.col];if(!o)return[];const n=o.color,a=[],i=(d,r)=>{d>=0&&d<8&&r>=0&&r<8&&a.push({row:d,col:r})};if(o.type==="pawn"){const d=n==="white"?-1:1,r=n==="white"?6:1,g=e.row+d,m=e.row+d*2;t||((h=this.board[g])==null?void 0:h[e.col])===null&&(a.push({row:g,col:e.col}),e.row===r&&((y=this.board[m])==null?void 0:y[e.col])===null&&a.push({row:m,col:e.col}));for(const f of[-1,1]){const k=e.col+f,I=e.row+d;k>=0&&k<8&&I>=0&&I<8&&a.push({row:I,col:k})}}o.type==="knight"&&[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([d,r])=>i(e.row+d,e.col+r));const p=[[-1,-1],[-1,1],[1,-1],[1,1]],u=[[-1,0],[1,0],[0,-1],[0,1]],c=[...p,...u],l=[];o.type==="bishop"&&l.push(...p),o.type==="rook"&&l.push(...u),o.type==="queen"&&l.push(...c);for(const[d,r]of l){let g=e.row+d,m=e.col+r;for(;g>=0&&g<8&&m>=0&&m<8&&(i(g,m),!this.board[g][m]);)g+=d,m+=r}if(o.type==="king")for(const[d,r]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])i(e.row+d,e.col+r);return a}isAttacked(e,t){const o=t==="white"?"black":"white";for(let n=0;n<8;n++)for(let a=0;a<8;a++){const i=this.board[n][a];if(i&&i.color===o&&this.getRawMoves({row:n,col:a},!0).some(u=>u.row===e.row&&u.col===e.col))return!0}return!1}}const N=class N{constructor(){b(this,"sounds");this.sounds={drag:new Audio("/assets/sounds/drag.mp3"),capture:new Audio("/assets/sounds/capture.mp3"),check:new Audio("/assets/sounds/check.mp3"),horse:new Audio("/assets/sounds/horse.mp3"),move:new Audio("/assets/sounds/move.mp3"),error:new Audio("/assets/sounds/error.mp3")}}static getInstance(){return N.instance||(N.instance=new N),N.instance}play(e){const t=this.sounds[e];t?(t.currentTime=0,t.play().catch(o=>{console.warn(`[AUDIO ERROR] Fallo al reproducir '${e}':`,o)})):console.warn(`[AUDIO] Sonido no encontrado: '${e}'`)}};b(N,"instance");let Y=N;const C=Y.getInstance();let Ie=0;function w(){return`piece_${Ie++}`}const de=[[{id:w(),type:"rook",color:"black",image:"black_rook.png",dragImage:"black_rook_drag.png"},{id:w(),type:"knight",color:"black",image:"black_knight.png",dragImage:"black_knight_drag.png"},{id:w(),type:"bishop",color:"black",image:"black_bishop.png",dragImage:"black_bishop_drag.png"},{id:w(),type:"queen",color:"black",image:"black_queen.png",dragImage:"black_queen_drag.png"},{id:w(),type:"king",color:"black",image:"black_king.png",dragImage:"black_king_drag.png"},{id:w(),type:"bishop",color:"black",image:"black_bishop2.png",dragImage:"black_bishop2_drag.png"},{id:w(),type:"knight",color:"black",image:"black_knight2.png",dragImage:"black_knight2_drag.png"},{id:w(),type:"rook",color:"black",image:"black_rook2.png",dragImage:"black_rook2_drag.png"}],[{id:w(),type:"pawn",color:"black",image:"black_pawn1.png",dragImage:"black_pawn1_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn2.png",dragImage:"black_pawn2_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn3.png",dragImage:"black_pawn3_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn4.png",dragImage:"black_pawn4_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn5.png",dragImage:"black_pawn5_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn6.png",dragImage:"black_pawn6_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn7.png",dragImage:"black_pawn7_drag.png"},{id:w(),type:"pawn",color:"black",image:"black_pawn8.png",dragImage:"black_pawn8_drag.png"}],Array(8).fill(null),Array(8).fill(null),Array(8).fill(null),Array(8).fill(null),[{id:w(),type:"pawn",color:"white",image:"white_pawn1.png",dragImage:"white_pawn1_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn2.png",dragImage:"white_pawn2_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn3.png",dragImage:"white_pawn3_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn4.png",dragImage:"white_pawn4_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn5.png",dragImage:"white_pawn5_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn6.png",dragImage:"white_pawn6_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn7.png",dragImage:"white_pawn7_drag.png"},{id:w(),type:"pawn",color:"white",image:"white_pawn8.png",dragImage:"white_pawn8_drag.png"}],[{id:w(),type:"rook",color:"white",image:"white_rook.png",dragImage:"white_rook_drag.png"},{id:w(),type:"knight",color:"white",image:"white_knight.png",dragImage:"white_knight_drag.png"},{id:w(),type:"bishop",color:"white",image:"white_bishop.png",dragImage:"white_bishop_drag.png"},{id:w(),type:"queen",color:"white",image:"white_queen.png",dragImage:"white_queen_drag.png"},{id:w(),type:"king",color:"white",image:"white_king.png",dragImage:"white_king_drag.png"},{id:w(),type:"bishop",color:"white",image:"white_bishop2.png",dragImage:"white_bishop2_drag.png"},{id:w(),type:"knight",color:"white",image:"white_knight2.png",dragImage:"white_knight2_drag.png"},{id:w(),type:"rook",color:"white",image:"white_rook2.png",dragImage:"white_rook2_drag.png"}]];function ae(s){const e=Math.floor(s/60),t=s%60;return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function pe(s,e){const t=document.createElement("div");t.id="black-timer",t.className="timer-box";const o=document.createElement("div");if(o.id="white-timer",o.className="timer-box",!document.getElementById("timers-style")){const a=document.createElement("style");a.id="timers-style",a.textContent=`
      .timer-box {
        position: fixed;
        right: 10px;
        width: auto;
        min-width: 100px;
        max-width: 160px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-family: monospace;
        font-size: 1.3rem;
        padding: 10px 14px;
        border-radius: 8px;
        text-align: right;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 0 8px rgba(0,0,0,0.4);
        user-select: none;
      }

      #black-timer {
        top: 10px;
      }

      #white-timer {
        bottom: 10px;
      }

      #board-holder {
        margin-top: 80px;
        margin-bottom: 80px;
      }

      @media (max-width: 500px) {
        .timer-box {
          font-size: 1rem;
          padding: 8px 10px;
          min-width: 80px;
        }
      }
    `,document.head.appendChild(a)}document.body.appendChild(t),document.body.appendChild(o);function n(){t.textContent=ae(e.getTime("black")),o.textContent=ae(e.getTime("white")),requestAnimationFrame(n)}n()}const ie={"no-time":{base:1/0,increment:0},blitz:{base:3*60,increment:2},rapid:{base:10*60,increment:5},classic:{base:15*60,increment:0}};class ue{constructor(e,t){b(this,"whiteTime");b(this,"blackTime");b(this,"activeColor","white");b(this,"intervalId",null);b(this,"increment");b(this,"updateCallback",null);this.control=e,this.onTimeout=t;const{base:o,increment:n}=ie[e];this.whiteTime=o,this.blackTime=o,this.increment=n}setUpdateCallback(e){this.updateCallback=e}startTurn(e){this.stop(),this.activeColor=e,this.control!=="no-time"&&(this.intervalId=window.setInterval(()=>{var t;this.activeColor==="white"?this.whiteTime--:this.blackTime--,(t=this.updateCallback)==null||t.call(this),this.getTime(e)<=0&&(this.stop(),this.onTimeout(e))},1e3))}stop(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null)}addIncrement(e){this.increment>0&&this.control!=="no-time"&&(e==="white"?this.whiteTime+=this.increment:this.blackTime+=this.increment)}getTime(e){return e==="white"?this.whiteTime:this.blackTime}formatTime(e){if(e===1/0)return"∞";const t=Math.floor(e/60).toString().padStart(2,"0"),o=Math.floor(e%60).toString().padStart(2,"0");return`${t}:${o}`}getFormattedTime(e){return this.formatTime(this.getTime(e))}getActiveColor(){return this.activeColor}reset(){this.stop();const{base:e}=ie[this.control];this.whiteTime=e,this.blackTime=e,this.activeColor="white"}}let v=new ue("classic",()=>{});function Ce(s){v=s}const ve={white:[[{from:{row:6,col:4},to:{row:4,col:4}},{from:{row:7,col:6},to:{row:5,col:5}}],[{from:{row:6,col:3},to:{row:4,col:3}},{from:{row:7,col:1},to:{row:5,col:2}}]],black:[[{from:{row:1,col:4},to:{row:3,col:4}},{from:{row:0,col:6},to:{row:2,col:5}}],[{from:{row:1,col:3},to:{row:3,col:3}},{from:{row:0,col:1},to:{row:2,col:2}}]]};function me(s,e,t){if(t){const p=t.getCurrentTurn();if(!t.hasAnyLegalMove(p)&&t.isInCheck(p))return p!==e?1e4:-1e4;if(!t.hasAnyLegalMove(p)&&!t.isInCheck(p))return 0}const o={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100};let n=0,a=0,i=null;for(let p=0;p<8;p++)for(let u=0;u<8;u++){const c=s[p][u];if(c){const l=o[c.type];n+=c.color===e?l:-l,a++,c.type==="king"&&c.color!==e&&(i={row:p,col:u})}}if(t){const p=z(t).length,u=t.getCurrentTurn();t.currentTurn=u==="white"?"black":"white";const c=z(t).length;t.currentTurn=u,n+=.1*(p-c)}if(a<=5&&i){const u=Math.min(...[{row:0,col:0},{row:0,col:7},{row:7,col:0},{row:7,col:7}].map(c=>Math.abs(c.row-i.row)+Math.abs(c.col-i.col)));n+=(14-u)*.5}return n+=Math.random()*.01,n}function z(s){const e=s.getBoard(),t=s.getCurrentTurn(),o=[];for(let n=0;n<8;n++)for(let a=0;a<8;a++){const i=e[n][a];if(i&&i.color===t){const p={row:n,col:a};for(const u of s.getLegalMoves(p))o.push({from:p,to:u})}}return o}function K(s,e,t,o){if(e===0||z(s).length===0)return me(s.getBoard(),o,s);const n=z(s);if(t){let a=-1/0;for(const i of n){const p=s.clone();p.makeMove(i.from,i.to);const u=K(p,e-1,!1,o);a=Math.max(a,u)}return a}else{let a=1/0;for(const i of n){const p=s.clone();p.makeMove(i.from,i.to);const u=K(p,e-1,!0,o);a=Math.min(a,u)}return a}}function X(s,e,t,o,n,a){if(e===0||z(s).length===0)return me(s.getBoard(),a,s);const i=z(s);if(n){let p=-1/0;for(const u of i){const c=s.clone();if(c.makeMove(u.from,u.to),p=Math.max(p,X(c,e-1,t,o,!1,a)),t=Math.max(t,p),t>=o)break}return p}else{let p=1/0;for(const u of i){const c=s.clone();if(c.makeMove(u.from,u.to),p=Math.min(p,X(c,e-1,t,o,!0,a)),o=Math.min(o,p),o<=t)break}return p}}function xe(s,e){var y;const t=s.getBoard(),o=s.getCurrentTurn(),n=[];for(let d=0;d<8;d++)for(let r=0;r<8;r++){const g=t[d][r];if(g&&g.color===o){const m={row:d,col:r};for(const f of s.getLegalMoves(m)){const k=t[f.row][f.col];n.push({from:m,to:f,capture:!!k})}}}if(n.length===0)return null;const a=((y=s.getMoveHistory)==null?void 0:y.call(s).length)??0;if(e!=="easy"&&a<4){const d=ve[o],g=d[Math.floor(Math.random()*d.length)][a/2];if(g&&s.getLegalMoves(g.from).some(m=>m.row===g.to.row&&m.col===g.to.col)){const m=s.makeMove(g.from,g.to),f=t[g.to.row][g.to.col];return m?{from:g.from,to:g.to,capture:!!f}:null}}for(const d of n){const r=s.clone();r.makeMove(d.from,d.to);const g=r.getCurrentTurn();if(!r.hasAnyLegalMove(g)&&r.isInCheck(g))return s.makeMove(d.from,d.to)?{from:d.from,to:d.to,capture:d.capture,checkmate:!0}:null}let i=[],p=-1/0;if(e==="easy"){const d=n.filter(r=>r.capture);i=d.length>0?[d[Math.floor(Math.random()*d.length)]]:[n[Math.floor(Math.random()*n.length)]]}else{const d=e==="medium"?1:2;for(const r of n){const g=s.clone();g.makeMove(r.from,r.to);const m=e==="medium"?K(g,d-1,!1,o):X(g,d-1,-1/0,1/0,!1,o);m>p?(p=m,i=[r]):m===p&&i.push(r)}}const u=i[Math.floor(Math.random()*i.length)],c=s.makeMove(u.from,u.to),l=s.getCurrentTurn(),h=!s.hasAnyLegalMove(l)&&s.isInCheck(l);return c?{from:u.from,to:u.to,capture:u.capture,checkmate:h}:null}function G(s,e,t){const o=document.getElementById("app"),n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="9999",n.style.animation="fadeIn 0.5s ease";let a="linear-gradient(to bottom right, rgba(0,0,0,0.8), rgba(30,30,30,0.9))";s.toLowerCase().includes("white")?a="linear-gradient(to bottom right, rgba(255,255,255,0.8), rgba(200,200,200,0.9))":s.toLowerCase().includes("black")?a="linear-gradient(to bottom right, rgba(0,0,0,0.8), rgba(20,20,20,0.95))":a="linear-gradient(to bottom right, rgba(100,100,100,0.8), rgba(60,60,60,0.9))",n.style.background=a;const i=document.createElement("div");i.style.backgroundColor="#fff",i.style.padding="40px",i.style.borderRadius="15px",i.style.boxShadow="0 0 25px rgba(255, 255, 255, 0.1)",i.style.textAlign="center",i.style.animation="popUp 0.5s ease",i.style.maxWidth="90%",i.style.minWidth="300px";const p=document.createElement("img");p.src="/logo.png",p.alt="Game Logo",p.style.width="80px",p.style.marginBottom="20px";const u=document.createElement("div");u.style.fontSize="3rem",u.style.marginBottom="10px";let c=new Audio,l=s;s.toLowerCase().includes("white")?(u.textContent="♔",u.style.color="#ddd",l=window.playerColor==="white"?"You Won!":"You Lost!",c=new Audio(window.playerColor==="white"?"/assets/sounds/victory.mp3":"/assets/sounds/defeat.mp3")):s.toLowerCase().includes("black")?(u.textContent="♚",u.style.color="#222",l=window.playerColor==="black"?"You Won!":"You Lost!",c=new Audio(window.playerColor==="black"?"/assets/sounds/victory.mp3":"/assets/sounds/defeat.mp3")):s.toLowerCase().includes("desconect")?(u.textContent="❌",u.style.color="#e74c3c",l="Your opponent disconnected.",c=new Audio("/assets/sounds/defeat.mp3")):(u.textContent="🤝",u.style.color="#888",l="Draw!",c=new Audio("/assets/sounds/draw.mp3")),c.play().catch(console.error);const h=document.createElement("h2");h.textContent=l,h.style.margin="0",h.style.fontSize="2rem",h.style.color="#333";const y=document.createElement("div");y.style.marginTop="25px",y.style.display="flex",y.style.justifyContent="center",y.style.gap="15px",y.style.flexWrap="wrap";const d=document.createElement("button");d.textContent="Play Again",d.style.padding="12px 25px",d.style.fontSize="1rem",d.style.cursor="pointer",d.style.backgroundColor="#444",d.style.color="white",d.style.border="none",d.style.borderRadius="8px",d.style.transition="background-color 0.3s",d.tabIndex=0,d.onmouseenter=()=>d.style.backgroundColor="#666",d.onmouseleave=()=>d.style.backgroundColor="#444",d.onclick=()=>{n.remove(),V(),e()};const r=document.createElement("button");if(r.textContent="Main Menu",r.style.padding="12px 25px",r.style.fontSize="1rem",r.style.cursor="pointer",r.style.backgroundColor="#222",r.style.color="white",r.style.border="none",r.style.borderRadius="8px",r.style.transition="background-color 0.3s",r.tabIndex=0,r.onmouseenter=()=>r.style.backgroundColor="#444",r.onmouseleave=()=>r.style.backgroundColor="#222",r.onclick=()=>{n.remove(),V(),t()},!document.getElementById("gameover-modal-style")){const m=document.createElement("style");m.id="gameover-modal-style",m.innerHTML=`
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes popUp {
        0% { transform: scale(0.6); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
    `,document.head.appendChild(m)}y.appendChild(d),y.appendChild(r),i.appendChild(p),i.appendChild(u),i.appendChild(h),i.appendChild(y),n.appendChild(i),o.appendChild(n);const g=m=>{m.key==="Escape"&&(n.remove(),V(),t(),window.removeEventListener("keydown",g))};window.addEventListener("keydown",g)}class Te{constructor(){b(this,"config",null)}setConfig(e){this.config=e,window.playerColor=e.playerColor}getConfig(){if(!this.config)throw new Error("Game configuration not set.");return this.config}getPlayerColor(){if(!this.config)throw new Error("Game configuration not set.");return this.config.playerColor}isAgainstAI(){var e;return((e=this.config)==null?void 0:e.mode)==="ai"}reset(){this.config=null,delete window.playerColor}}const R=new Te;function oe(s,e){const t=document.createElement("div");return t.id="menu-screen",s.style.position="absolute",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -60%)",s.style.opacity="0",s.style.transition="opacity 0.6s ease, transform 0.6s ease",setTimeout(()=>{s.style.opacity="1",s.style.transform="translate(-50%, -50%)"},50),t.appendChild(s),e&&t.appendChild(e),t}function Ee(){const s=document.getElementById("app");s.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="20px";const t=document.createElement("h2");t.textContent="Selecciona la dificultad de la IA",e.appendChild(t);const o=[{label:"🟢 Fácil",value:"easy"},{label:"🟡 Media",value:"medium"},{label:"🔴 Difícil",value:"hard"}];let n="easy";for(const{label:c,value:l}of o){const h=document.createElement("button");h.className="menu-btn",h.textContent=c,h.style.width="260px",h.addEventListener("click",()=>{n=l,a()}),e.appendChild(h)}function a(){e.innerHTML="";const c=document.createElement("h2");c.textContent="¿Quién empieza?",e.appendChild(c);const l=document.createElement("button");l.textContent="Empiezas tú",i(l);const h=document.createElement("button");h.textContent="Empieza la IA",i(h),l.addEventListener("click",()=>{p(),R.setConfig({mode:"ai",playerColor:"white",aiLevel:n}),U()}),h.addEventListener("click",()=>{p(),R.setConfig({mode:"ai",playerColor:"black",aiLevel:n}),U()}),e.appendChild(l),e.appendChild(h)}function i(c){c.className="menu-btn",c.style.width="260px"}function p(){e.querySelectorAll("button").forEach(l=>l.disabled=!0)}const u=oe(e,ne(["ai"]));s.appendChild(u)}function Me(){const s=document.getElementById("app");s.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.height="100vh",e.style.gap="20px";const t=document.createElement("p");t.textContent="Esperando a que el oponente acepte la invitación...",t.style.fontSize="1.2rem",t.style.color="white",e.appendChild(t);const o=document.createElement("button");o.textContent="Cancelar",o.className="menu-btn",o.style.width="260px",o.onclick=()=>{A.getInstance().send({type:"error",message:"Invitación cancelada por el remitente."}),S()},e.appendChild(o),s.appendChild(e)}function Z(s,e="Aviso",t={}){const o=document.getElementById("custom-modal");o&&o.remove();const n=document.createElement("div");n.id="custom-modal",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.backgroundColor="rgba(0, 0, 0, 0.7)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="9999";const a=document.createElement("div");a.style.background="white",a.style.padding="2.5rem",a.style.borderRadius="16px",a.style.textAlign="center",a.style.width="min(90vw, 420px)",a.style.boxShadow="0 0 15px rgba(0,0,0,0.5)",a.style.fontFamily="Segoe UI, sans-serif";const i=document.createElement("h3");i.textContent=e,i.style.marginBottom="1.5rem",a.appendChild(i);const p=document.createElement("p");p.textContent=s,p.style.marginBottom="2rem",a.appendChild(p);const u=document.createElement("div");u.style.display="flex",u.style.justifyContent="center",u.style.gap="1rem";const c=document.createElement("button");if(c.textContent=t.confirmText||"Aceptar",c.className="menu-btn",c.style.width="140px",c.onclick=()=>{n.remove(),t.onConfirm&&t.onConfirm()},u.appendChild(c),t.cancelText){const l=document.createElement("button");l.textContent=t.cancelText,l.className="menu-btn",l.style.width="140px",l.onclick=()=>{n.remove(),t.onCancel&&t.onCancel()},u.appendChild(l)}a.appendChild(u),n.appendChild(a),document.body.appendChild(n)}function _e(){const s=document.getElementById("app");s.innerHTML="";const e=x.getInstance().getLocalId()||"(esperando ID...)",t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="20px";const o=document.createElement("h2");o.textContent="Conectar con otro jugador",o.style.fontSize="1.8rem",t.appendChild(o);const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.gap="0.75rem",n.style.background="rgba(0, 0, 0, 0.5)",n.style.padding="1rem 2rem",n.style.borderRadius="12px",n.style.minWidth="400px";const a=document.createElement("img");a.src="/assets/img/userID.png",a.alt="user icon",a.style.width="60px",a.style.height="60px";const i=document.createElement("div");i.className="player-id",i.innerHTML=`<strong>${e}</strong>`,i.style.fontSize="1.8rem",i.style.color="white",i.style.whiteSpace="nowrap",i.style.display="flex",i.style.alignItems="center",i.style.gap="0.5rem";const p=document.createElement("img");p.src="/assets/img/copy.png",p.alt="Copiar ID",p.style.width="60px",p.style.height="60px",p.style.cursor="pointer",p.title="Copiar ID",p.addEventListener("click",()=>{navigator.clipboard.writeText(e).then(()=>{p.src="/assets/img/check.png",setTimeout(()=>p.src="/assets/img/copy.png",1500)})}),n.appendChild(a),n.appendChild(i),n.appendChild(p),t.appendChild(n);const u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.gap="10px",u.style.minWidth="350px";const c=document.createElement("img");c.src="/assets/img/paste.png",c.alt="Pegar ID",c.title="Pegar ID desde el portapapeles",c.style.width="60px",c.style.height="60px",c.style.cursor="pointer";const l=document.createElement("input");l.type="text",l.placeholder="Introduce el ID del oponente",l.id="opponent-id",l.name="opponent-id",l.style.padding="10px",l.style.fontSize="18px",l.style.width="100%",l.style.borderRadius="8px",l.style.border="1px solid #ccc",l.style.textAlign="center",l.style.flex="1",c.addEventListener("click",()=>{navigator.clipboard.readText().then(r=>{l.value=r})}),u.appendChild(c),u.appendChild(l),t.appendChild(u);const h=document.createElement("button");h.textContent="Enviar invitación",h.className="menu-btn",h.style.width="350px",t.appendChild(h);const y=document.createElement("p");y.style.color="red",t.appendChild(y),h.onclick=()=>{const r=l.value.trim(),g=x.getInstance().getLocalId();if(!/^Player\d{6}$/.test(r)){Z("Introduce un ID válido como Player123456","⚠️ Formato incorrecto",{confirmText:"Aceptar",onConfirm:()=>{l.value=""}}),setTimeout(()=>{const k=document.getElementById("custom-modal");if(k){const I=k.querySelector("p"),E=k.querySelector("h3");E&&(E.style.fontSize="1.6rem"),I&&(I.style.fontSize="1.2rem")}},10);return}x.getInstance().setOpponentId(r);const f={type:"join_request",fromId:g,toId:r};A.getInstance().send(f),Me()};const d=oe(t,ne(["id"]));s.appendChild(d)}function ne(s=[]){const e=document.createElement("div");e.className="menu-buttons",e.style.display="flex",e.style.flexDirection="row",e.style.justifyContent="center";const t=[{label:"Jugar contra la IA",value:"ai",action:()=>Ee()},{label:"Jugar con un amigo",value:"id",action:()=>_e()},{label:"Jugar en línea",value:"random",action:()=>{const o=x.getInstance().getLocalId();if(!o||o==="esperando"){alert("Esperando asignación de ID por el servidor. Intenta de nuevo en unos segundos.");return}A.getInstance().send({type:"find_random_opponent",id:o}),alert("Buscando oponente aleatorio...")}}];for(const{label:o,value:n,action:a}of t){if(s.includes(n))continue;const i=document.createElement("button");i.className="menu-btn",i.textContent=o,i.addEventListener("click",a),e.appendChild(i)}return e}function S(){const s=document.getElementById("app");s.innerHTML="";const e=x.getInstance().getLocalId()||"(esperando ID...)",t=document.createElement("div");t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.gap="0.75rem",t.style.background="rgba(0, 0, 0, 0.5)",t.style.padding="1rem 2rem",t.style.borderRadius="12px";const o=document.createElement("img");o.src="/assets/img/userID.png",o.alt="user icon",o.style.width="60px",o.style.height="60px";const n=document.createElement("div");n.className="player-id",n.innerHTML=`<strong>${e}</strong>`,n.style.fontSize="1.6rem",n.style.color="white",n.style.whiteSpace="nowrap",n.style.display="flex",n.style.alignItems="center",n.style.gap="0.5rem";const a=document.createElement("img");a.src="/assets/img/copy.png",a.alt="Copiar ID",a.style.width="60px",a.style.height="60px",a.style.cursor="pointer",a.title="Copiar ID",a.addEventListener("click",()=>{navigator.clipboard.writeText(e).then(()=>{a.src="/assets/img/check.png",setTimeout(()=>a.src="/assets/img/copy.png",1500)})}),t.appendChild(o),t.appendChild(n),t.appendChild(a);const i=oe(t,ne());s.appendChild(i)}let j=!0,$=null,L=null,_=null;function ge(){const s=["rook","rook2","knight","knight2","bishop","bishop2","queen","king"],e=Array.from({length:8},(i,p)=>`pawn${p+1}`),t=[...s,...e],o=["white","black"],n=["","_drag","_check"];let a=document.getElementById("preload-pieces");a||(a=document.createElement("div"),a.id="preload-pieces",a.style.position="absolute",a.style.top="-9999px",a.style.left="-9999px",document.body.appendChild(a));for(const i of o)for(const p of t)for(const u of n){if(u==="_check"&&p!=="king")continue;const c=`${i}_${p}${u}.png`;if(!document.getElementById(c)){const l=new Image;l.id=c,l.src=`/assets/pieces/${c}`,l.style.width="1px",l.style.height="1px",l.onload=()=>console.log(`Imagen precargada: ${c}`),l.onerror=()=>console.warn(`No se pudo cargar: ${c}`),a.appendChild(l)}}}ge();document.addEventListener("click",function s(){console.log("[AUDIO] Desbloqueando sonido con primer click"),document.removeEventListener("click",s)},{once:!0});function U(){const s=document.getElementById("app");s.innerHTML="";let e=document.getElementById("board-holder");e||(e=document.createElement("div"),e.id="board-holder",s.appendChild(e)),ge();const t=R.getConfig();let o;t.mode==="online"?o=Ae():o=new F(de),pe(s,v),B(o,o.getBoard()),j=t.mode!=="ai"||t.playerColor==="white",v.startTurn(o.getCurrentTurn()),t.mode==="ai"&&t.playerColor==="black"&&setTimeout(()=>ee(o),500)}function Le(s,e,t,o){const n=s.getBoard().map(h=>h.map(y=>y?{...y}:null)),a=document.getElementById("chess-board");if(console.log("[animateRemoteMove] Animando movimiento remoto",e,t),!a){console.warn("[animateRemoteMove] No se encontró el tablero.");return}const i=e.row*8+e.col,p=t.row*8+t.col,u=a.children[i],c=a.children[p],l=u==null?void 0:u.querySelector("img");if(l&&c){console.log("[animateRemoteMove] Imagen encontrada para animar:",l.src);const h=l.dataset.dragSrc||l.dataset.defaultSrc;h&&(l.src=`/assets/pieces/${h}`);const y=l.getBoundingClientRect(),d=c.getBoundingClientRect(),r=l.cloneNode(!0);r.style.position="fixed",r.style.left=`${y.left}px`,r.style.top=`${y.top}px`,r.style.width=`${y.width}px`,r.style.height=`${y.height}px`,r.style.pointerEvents="none",r.style.transition="left 0.4s linear, top 0.4s linear, opacity 0.1s",document.body.appendChild(r),l.style.visibility="hidden",setTimeout(()=>{r.style.left=`${d.left}px`,r.style.top=`${d.top}px`},10),setTimeout(()=>{r.style.opacity="0",setTimeout(()=>{document.body.removeChild(r),l.style.visibility="visible",l.src=`/assets/pieces/${l.dataset.defaultSrc}`;const m=n[t.row][t.col]!==null;s.makeMove(e,t),_={from:e,to:t},m?C.play("capture"):C.play("move");const f=s.getCurrentTurn();R.getConfig(),v.addIncrement(f==="white"?"black":"white"),v.startTurn(f),B(s,s.getBoard()),s.isInCheck(f)&&C.play("check"),o&&o()},100)},1e3)}else{console.warn("[animateRemoteMove] No se pudo encontrar la imagen para animar el movimiento.");const y=s.getBoard()[t.row][t.col]!==null;s.makeMove(e,t),_={from:e,to:t},C.play(y?"capture":"move");const d=s.getCurrentTurn();v.addIncrement(d==="white"?"black":"white"),v.startTurn(d),B(s,s.getBoard()),s.isInCheck(d)&&C.play("check"),o&&o()}}function B(s,e){if(!s){console.error("Engine is not initialized. Call showBoard() first.");return}let t=document.getElementById("board-holder");if(!t){const c=document.getElementById("app");if(!c){console.error("No se encontró el contenedor #app");return}t=document.createElement("div"),t.id="board-holder",c.appendChild(t)}const o=document.createElement("div");o.id="chess-board",o.style.display="grid",o.style.gridTemplateColumns="repeat(8, 1fr)",o.style.width="min(90vmin, 90vw)",o.style.height="min(90vmin, 90vw)",o.style.margin="auto",o.style.border="4px solid black",t.innerHTML="",t.appendChild(o);const n=s.isInCheck("white"),a=s.isInCheck("black"),i=R.getConfig();let p=[];$&&(p=s.getLegalMoves($));const u=["a","b","c","d","e","f","g","h"];for(let c=0;c<8;c++)for(let l=0;l<8;l++){const h=document.createElement("div"),y=(c+l)%2===0;if(h.style.backgroundColor=y?"#c2b280":"#6f4e37",h.style.width="100%",h.style.height="100%",h.style.position="relative",c===7){const r=document.createElement("span");r.textContent=u[l],r.className="cell-label file-label",h.appendChild(r)}if(l===0){const r=document.createElement("span");r.textContent=`${8-c}`,r.className="cell-label rank-label",h.appendChild(r)}const d=e[c][l];if(d){const r=document.createElement("img"),g=d.type==="king"&&(d.color==="white"&&n||d.color==="black"&&a);g&&h.classList.add("in-check");const m=g?`${d.color}_king_check.png`:d.image;if(r.src=`/assets/pieces/${m}`,r.dataset.defaultSrc=d.image,r.dataset.dragSrc=g?`${d.color}_king_check.png`:d.dragImage||d.image,r.style.width="100%",r.style.height="100%",r.style.objectFit="contain",r.draggable=!1,r.style.zIndex="10",h.appendChild(r),p.some(f=>f.row===c&&f.col===l)){const f=document.createElement("div");f.className="legal-move-dot",h.appendChild(f)}}if($&&p.some(r=>r.row===c&&r.col===l)){const r=document.createElement("div");r.className="legal-move-dot",h.appendChild(r)}_&&(c===_.from.row&&l===_.from.col||c===_.to.row&&l===_.to.col)&&h.classList.add("last-move-cell"),h.addEventListener("click",()=>{if(!j||i.mode==="online"&&!$e())return;const r={row:c,col:l},g=e[c][l];if((!$||g&&g.color===i.playerColor)&&(L&&L.classList.remove("selected-cell"),g&&g.color===i.playerColor)){$=r,L=null,B(s,s.getBoard());const m=document.getElementById("chess-board");if(m){const f=r.row*8+r.col,k=m.children[f];k&&(k.classList.add("selected-cell"),L=k)}return}if($){const m=$,f=e[r.row][r.col]!==null;if(s.makeMove(m,r)){$=null,L&&L.classList.remove("selected-cell"),L=null,j=!1,v.addIncrement(i.playerColor),v.startTurn(s.getCurrentTurn());const I=document.getElementById("chess-board");if(I){const E=m.row*8+m.col,W=r.row*8+r.col,J=I.children[E],se=I.children[W],M=J==null?void 0:J.querySelector("img");if(M&&se){M.dataset.dragSrc&&(M.src=`/assets/pieces/${M.dataset.dragSrc}`),setTimeout(()=>{const O=M.getBoundingClientRect(),re=se.getBoundingClientRect(),T=M.cloneNode(!0);T.style.position="fixed",T.style.left=`${O.left}px`,T.style.top=`${O.top}px`,T.style.width=`${O.width}px`,T.style.height=`${O.height}px`,T.style.pointerEvents="none",T.style.transition="left 0.4s linear, top 0.4s linear, opacity 0.1s",document.body.appendChild(T),M.style.visibility="hidden",setTimeout(()=>{T.style.left=`${re.left}px`,T.style.top=`${re.top}px`},10),setTimeout(()=>{T.style.opacity="0",setTimeout(()=>{document.body.removeChild(T),M.dataset.defaultSrc&&(M.src=`/assets/pieces/${M.dataset.defaultSrc}`),M.style.visibility="visible",f?C.play("capture"):C.play("move"),_={from:m,to:r},B(s,s.getBoard());const he=s.getCurrentTurn();s.isInCheck(he)&&C.play("check"),i.mode==="online"&&le(m,r),i.mode==="ai"&&s.getCurrentTurn()!==i.playerColor?setTimeout(()=>ee(s),1e3):j=!0},100)},510)},200);return}}f?C.play("capture"):C.play("move"),_={from:m,to:r},B(s,s.getBoard()),i.mode==="online"&&le(m,r),i.mode==="ai"&&s.getCurrentTurn()!==i.playerColor?setTimeout(()=>ee(s),1e3):j=!0}else C.play("error"),$=null,L&&L.classList.remove("selected-cell"),L=null,B(s,s.getBoard())}}),o.appendChild(h)}}function ee(s){const e=R.getConfig();if(!e.aiLevel){console.error("AI difficulty level is not set."),G("AI configuration error. Returning to main menu.",()=>{S()},()=>{S()});return}const t=s.getBoard().map(c=>c.map(l=>l?{...l}:null)),o=xe(s,e.aiLevel);if(!o){const c=s.getCurrentTurn(),l=e.playerColor,h=s.isInCheck(c)&&c===l,y=s.isInCheck(c)&&c!==l,d=!s.isInCheck(c);let r="";h?r="¡Has perdido! (Jaque mate)":y?r="¡Has ganado! (Jaque mate)":d&&(r="Tablas (ahogado)"),G(r,()=>U(),()=>S());return}if(o.checkmate){const l=(s.getCurrentTurn()==="white"?"black":"white")===e.playerColor?"¡Has ganado! (Jaque mate)":"¡Has perdido! (Jaque mate)";setTimeout(()=>{G(l,()=>U(),()=>S())},300);return}const n=document.getElementById("chess-board");if(n){const c=o.from.row*8+o.from.col,l=o.to.row*8+o.to.col,h=n.children[c],y=n.children[l],d=h==null?void 0:h.querySelector("img");if(d&&y){d.dataset.dragSrc&&(d.src=`/assets/pieces/${d.dataset.dragSrc}`),setTimeout(()=>{const r=d.getBoundingClientRect(),g=y.getBoundingClientRect(),m=d.cloneNode(!0);m.style.position="fixed",m.style.left=`${r.left}px`,m.style.top=`${r.top}px`,m.style.width=`${r.width}px`,m.style.height=`${r.height}px`,m.style.pointerEvents="none",m.style.transition="left 0.4s linear, top 0.4s linear, opacity 0.1s",document.body.appendChild(m),d.style.visibility="hidden",setTimeout(()=>{m.style.left=`${g.left}px`,m.style.top=`${g.top}px`},10),setTimeout(()=>{m.style.opacity="0",setTimeout(()=>{document.body.removeChild(m),d.dataset.defaultSrc&&(d.src=`/assets/pieces/${d.dataset.defaultSrc}`),d.style.visibility="visible";const k=t[o.to.row][o.to.col]!==null;s.makeMove(o.from,o.to),_={from:o.from,to:o.to},k?C.play("capture"):C.play("move");const I=s.getCurrentTurn(),E=I==="white"?"black":"white";v.addIncrement(E),v.startTurn(I),B(s,s.getBoard()),s.isInCheck(I)&&C.play("check"),j=!0},100)},410)},200);return}}s.makeMove(o.from,o.to),_={from:o.from,to:o.to},s.getBoard();const a=t[o.to.row][o.to.col];a!==null&&a.color!==s.getCurrentTurn()?C.play("capture"):C.play("move");const p=s.getCurrentTurn(),u=p==="white"?"black":"white";v.addIncrement(u),v.startTurn(p),B(s,s.getBoard()),s.isInCheck(p)&&C.play("check"),console.log("AI move executed:",o),j=!0}let P,H=!1,te=!1;function Se(s){if(console.log("[RemoteGame] startRemoteGame ejecutado",s),te){console.warn("[RemoteGame] La partida remota ya ha sido iniciada.");return}te=!0;const e=document.getElementById("app"),t=document.createElement("div");t.id="board-holder",e&&(e.innerHTML="",e.appendChild(t));const o=x.getInstance().getLocalId();if(!o){console.error("[RemoteGame] ERROR: El ID local no está asignado antes de iniciar la partida.");return}const n=s.whiteId===o?"white":"black";console.log(`[RemoteGame] Mi ID: ${o}, White: ${s.whiteId}, Black: ${s.blackId}, Mi color: ${n}`),console.log("[RemoteGame] Inicializando engine"),P=new F(de),R.setConfig({mode:"online",playerColor:n}),H=n==="white",Ce(new ue("classic",a=>{const p=R.getConfig().playerColor;G(a===p?"¡Has perdido por tiempo!":"¡Has ganado por tiempo!",()=>S(),()=>S())})),v.reset(),H&&v.startTurn(n),pe(t,v),console.log("[Board] renderBoard llamado",P),B(P,P.getBoard())}function Be(s){console.log("[RemoteGame] handleRemoteMove",s),R.getConfig(),s.playerId!==x.getInstance().getLocalId()&&Le(P,s.from,s.to,()=>{H=!0})}function le(s,e){const t={type:"move",from:s,to:e,playerId:x.getInstance().getLocalId()};A.getInstance().send(t),H=!1}function Ae(){return P}function $e(){return H}function V(){te=!1}console.log("[Client] initWebSocketListeners ejecutado");let ce=!1;function Re(){if(console.log("[Client] initWebSocketListeners ejecutado"),ce)return;ce=!0;const s=A.getInstance();s.on("join_request",e=>{console.log("[Listener] join_request recibido",e),we(e)}),s.on("start_game",e=>{console.log("[Listener] start_game recibido",e),Se(e)}),s.on("join_response",e=>{const t=e;if(!t.accepted){let o="No se pudo conectar con el jugador.",n="⛔ Error",a="/assets/img/warning.png";switch(t.reason){case"not_found":o="El ID introducido no existe o el jugador no está conectado.",n="❌ ID no encontrado",a="/assets/img/warning.png";break;case"in_game":o="El jugador ya está en una partida.",n="🎮 Jugador ocupado",a="/assets/img/busy.png";break;case"rejected":o="El jugador ha rechazado tu invitación.",n="🙅 Invitación rechazada",a="/assets/img/rejected.png";break}Z(o,n,{confirmText:"Aceptar",iconSrc:a,onConfirm:()=>{S()}})}}),s.on("opponent_disconnected",e=>{"playerId"in e&&Z("Tu oponente se ha desconectado.","🔌 Desconexión",{confirmText:"Aceptar",iconSrc:"/assets/img/warning.png",onConfirm:()=>S()})}),s.on("init",e=>{const t=e;t.id!=="esperando"?(localStorage.setItem("playerId",t.id),x.getInstance().setLocalId(t.id),console.log("[Client] Received ID from server and stored:",t.id),S()):console.warn('[Client] ID "esperando" no se guarda en localStorage')}),s.on("move",e=>{Be(e)})}console.log("Starting Chess Game Client...");Re();const De=location.hostname==="localhost"?"ws://localhost:3000":"wss://cheess-game.onrender.com";A.getInstance().connect(De);
