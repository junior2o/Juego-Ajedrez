var re=Object.defineProperty;var se=(n,e,t)=>e in n?re(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var w=(n,e,t)=>se(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const B=class B{constructor(){w(this,"socket",null);w(this,"callbacks",{});w(this,"messageQueue",[]);w(this,"isConnected",!1)}static getInstance(){return B.instance||(B.instance=new B),B.instance}connect(e){this.socket=new WebSocket(e),this.socket.onopen=()=>{console.log("[WebSocket] Connected"),this.isConnected=!0;const t=localStorage.getItem("playerId")||"",o={type:"init_with_id",id:t};for(this.send(o),console.log("[WebSocket] Sent init_with_id:",t);this.messageQueue.length>0;){const r=this.messageQueue.shift();r&&this.send(r)}},this.socket.onmessage=t=>{try{const o=JSON.parse(t.data);this.dispatchMessage(o)}catch{console.error("[WebSocket] Invalid message received:",t.data)}},this.socket.onclose=()=>{console.warn("[WebSocket] Disconnected"),this.isConnected=!1},this.socket.onerror=t=>{console.error("[WebSocket] Error:",t)}}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.isConnected?this.socket.send(JSON.stringify(e)):(console.warn("[WebSocket] Not ready, message enqueued."),this.messageQueue.push(e))}on(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}off(e,t){const o=this.callbacks[e];o&&(this.callbacks[e]=o.filter(r=>r!==t))}dispatchMessage(e){const t=e.type;console.log("[WebSocket] dispatchMessage",t);const o=this.callbacks[t];o&&o.length>0?o.forEach(r=>r(e)):t in this.callbacks||console.warn("[WebSocket] Unhandled message type:",t,e)}};w(B,"instance");let v=B;const A=class A{constructor(){w(this,"localId","esperando");w(this,"opponentId",null);w(this,"matchId",null)}static getInstance(){return A.instance||(A.instance=new A),A.instance}setLocalId(e){this.localId=e;const t=document.getElementById("local-id-display");t&&(t.textContent=`Tu ID: ${e}`)}getLocalId(){return this.localId}setOpponentId(e){this.opponentId=e}getOpponentId(){return this.opponentId}setMatchId(e){this.matchId=e}getMatchId(){return this.matchId}reset(){this.opponentId=null,this.matchId=null}};w(A,"instance");let C=A;function ae(n){const e=document.getElementById("app");e.innerHTML="";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.height="100vh",t.style.gap="20px";const o=document.createElement("h2");o.textContent=`Invitación de: ${n.fromId}`,t.appendChild(o);const r=document.createElement("button");r.textContent="Aceptar",r.style.padding="10px 20px",r.style.fontSize="16px",r.style.cursor="pointer";const s=document.createElement("button");s.textContent="Rechazar",s.style.padding="10px 20px",s.style.fontSize="16px",s.style.cursor="pointer",r.onclick=()=>{const c=C.getInstance().getLocalId();C.getInstance().setOpponentId(n.fromId);const d={type:"join_response",accepted:!0,fromId:c,toId:n.fromId};v.getInstance().send(d)},s.onclick=()=>{const c={type:"join_response",accepted:!1,fromId:C.getInstance().getLocalId(),toId:n.fromId};v.getInstance().send(c),e.innerHTML="<p>Has rechazado la invitación.</p>"},t.appendChild(r),t.appendChild(s),e.appendChild(t)}let ie=1e3;function le(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`piece_${ie++}`}function G(n){return n.map(e=>e.map(t=>t?{...t}:null))}class O{constructor(e){w(this,"board");w(this,"currentTurn");w(this,"hasMoved",{});w(this,"enPassantTarget",null);w(this,"moveHistory",[]);this.board=G(e),this.currentTurn="white"}clone(){const e=new O(G(this.board));return e.currentTurn=this.currentTurn,e.hasMoved={...this.hasMoved},e.enPassantTarget=this.enPassantTarget?{...this.enPassantTarget}:null,e.moveHistory=[...this.moveHistory],e}isInCheck(e){let t=null;for(let r=0;r<8;r++){for(let s=0;s<8;s++){const c=this.board[r][s];if((c==null?void 0:c.type)==="king"&&c.color===e){t={row:r,col:s};break}}if(t)break}if(!t)return!1;const o=e==="white"?"black":"white";for(let r=0;r<8;r++)for(let s=0;s<8;s++){const c=this.board[r][s];if(c&&c.color===o&&this.getRawMoves({row:r,col:s},!0).some(l=>l.row===t.row&&l.col===t.col))return!0}return!1}getBoard(){return G(this.board)}getCurrentTurn(){return this.currentTurn}getMoveHistory(){return[...this.moveHistory]}makeMove(e,t){return!this.board[e.row][e.col]||!this.getLegalMoves(e).some(c=>c.row===t.row&&c.col===t.col)?!1:(this.applyMove(e,t),!0)}applyMove(e,t){const o=this.board[e.row][e.col];if(this.hasMoved[o.id]=!0,this.moveHistory.push({from:{...e},to:{...t}}),o.type==="pawn"&&this.enPassantTarget&&t.row===this.enPassantTarget.row&&t.col===this.enPassantTarget.col){const s=o.color==="white"?1:-1;this.board[t.row+s][t.col]=null}if(o.type==="king"&&Math.abs(t.col-e.col)===2){const s=e.row;t.col===6?(this.board[s][5]=this.board[s][7],this.board[s][7]=null):t.col===2&&(this.board[s][3]=this.board[s][0],this.board[s][0]=null)}this.board[t.row][t.col]=o,this.board[e.row][e.col]=null,this.currentTurn=this.currentTurn==="white"?"black":"white",o.type==="pawn"&&Math.abs(t.row-e.row)===2?this.enPassantTarget={row:(e.row+t.row)/2,col:e.col}:this.enPassantTarget=null;const r=o.color==="white"?0:7;o.type==="pawn"&&t.row===r&&(this.board[t.row][t.col]={id:le(),type:"queen",color:o.color,image:`${o.color}_queen.png`,dragImage:`${o.color}_queen_drag.png`})}getLegalMoves(e){var u,b,m,a;const t=this.board[e.row][e.col];if(!t)return[];const o=t.color,r=[],s=(i,g)=>{if(i>=0&&i<8&&g>=0&&g<8){const h=this.board[i][g];(!h||h.color!==o)&&r.push({row:i,col:g})}};if(t.type==="pawn"){const i=o==="white"?-1:1,g=o==="white"?6:1,h=e.row+i,y=e.row+i*2;((u=this.board[h])==null?void 0:u[e.col])===null&&(r.push({row:h,col:e.col}),e.row===g&&((b=this.board[y])==null?void 0:b[e.col])===null&&r.push({row:y,col:e.col}));for(const k of[-1,1]){const I=e.col+k,E=e.row+i;if(I>=0&&I<8){const j=(m=this.board[E])==null?void 0:m[I];j&&j.color!==o&&r.push({row:E,col:I}),((a=this.enPassantTarget)==null?void 0:a.row)===E&&this.enPassantTarget.col===I&&r.push({row:E,col:I})}}}t.type==="knight"&&[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([i,g])=>s(e.row+i,e.col+g));const c=[[-1,-1],[-1,1],[1,-1],[1,1]],d=[[-1,0],[1,0],[0,-1],[0,1]],l=[...c,...d],p=[];t.type==="bishop"&&p.push(...c),t.type==="rook"&&p.push(...d),t.type==="queen"&&p.push(...l);for(const[i,g]of p){let h=e.row+i,y=e.col+g;for(;h>=0&&h<8&&y>=0&&y<8;){const k=this.board[h][y];if(!k)r.push({row:h,col:y});else{k.color!==o&&r.push({row:h,col:y});break}h+=i,y+=g}}if(t.type==="king"){for(const[i,g]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])s(e.row+i,e.col+g);if(!this.hasMoved[t.id]&&!this.isInCheck(o)){const i=e.row,g=this.board[i][7];g&&g.type==="rook"&&g.color===o&&!this.hasMoved[g.id]&&this.board[i][5]===null&&this.board[i][6]===null&&!this.isAttacked({row:i,col:5},o)&&!this.isAttacked({row:i,col:6},o)&&r.push({row:i,col:6});const h=this.board[i][0];h&&h.type==="rook"&&h.color===o&&!this.hasMoved[h.id]&&this.board[i][1]===null&&this.board[i][2]===null&&this.board[i][3]===null&&!this.isAttacked({row:i,col:2},o)&&!this.isAttacked({row:i,col:3},o)&&r.push({row:i,col:2})}}return r.filter(i=>{const g=this.clone();return g.applyMove(e,i),!g.isInCheck(o)})}hasAnyLegalMove(e){for(let t=0;t<8;t++)for(let o=0;o<8;o++){const r=this.board[t][o];if((r==null?void 0:r.color)===e&&this.getLegalMoves({row:t,col:o}).length>0)return!0}return!1}getRawMoves(e,t=!1){var b,m;const o=this.board[e.row][e.col];if(!o)return[];const r=o.color,s=[],c=(a,i)=>{a>=0&&a<8&&i>=0&&i<8&&s.push({row:a,col:i})};if(o.type==="pawn"){const a=r==="white"?-1:1,i=r==="white"?6:1,g=e.row+a,h=e.row+a*2;t||((b=this.board[g])==null?void 0:b[e.col])===null&&(s.push({row:g,col:e.col}),e.row===i&&((m=this.board[h])==null?void 0:m[e.col])===null&&s.push({row:h,col:e.col}));for(const y of[-1,1]){const k=e.col+y,I=e.row+a;k>=0&&k<8&&I>=0&&I<8&&s.push({row:I,col:k})}}o.type==="knight"&&[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([a,i])=>c(e.row+a,e.col+i));const d=[[-1,-1],[-1,1],[1,-1],[1,1]],l=[[-1,0],[1,0],[0,-1],[0,1]],p=[...d,...l],u=[];o.type==="bishop"&&u.push(...d),o.type==="rook"&&u.push(...l),o.type==="queen"&&u.push(...p);for(const[a,i]of u){let g=e.row+a,h=e.col+i;for(;g>=0&&g<8&&h>=0&&h<8&&(c(g,h),!this.board[g][h]);)g+=a,h+=i}if(o.type==="king")for(const[a,i]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])c(e.row+a,e.col+i);return s}isAttacked(e,t){const o=t==="white"?"black":"white";for(let r=0;r<8;r++)for(let s=0;s<8;s++){const c=this.board[r][s];if(c&&c.color===o&&this.getRawMoves({row:r,col:s},!0).some(l=>l.row===e.row&&l.col===e.col))return!0}return!1}}class ce{constructor(){w(this,"sounds");this.sounds={drag:new Audio("/assets/sounds/drag.mp3"),capture:new Audio("/assets/sounds/capture.mp3"),check:new Audio("/assets/sounds/check.mp3"),horse:new Audio("/assets/sounds/horse.mp3")}}play(e){const t=this.sounds[e];t&&(t.currentTime=0,t.play().catch(console.error))}}let de=0;function f(){return`piece_${de++}`}const V=[[{id:f(),type:"rook",color:"black",image:"black_rook.png",dragImage:"black_rook_drag.png"},{id:f(),type:"knight",color:"black",image:"black_knight.png",dragImage:"black_knight_drag.png"},{id:f(),type:"bishop",color:"black",image:"black_bishop.png",dragImage:"black_bishop_drag.png"},{id:f(),type:"queen",color:"black",image:"black_queen.png",dragImage:"black_queen_drag.png"},{id:f(),type:"king",color:"black",image:"black_king.png",dragImage:"black_king_drag.png"},{id:f(),type:"bishop",color:"black",image:"black_bishop2.png",dragImage:"black_bishop2_drag.png"},{id:f(),type:"knight",color:"black",image:"black_knight2.png",dragImage:"black_knight2_drag.png"},{id:f(),type:"rook",color:"black",image:"black_rook2.png",dragImage:"black_rook2_drag.png"}],[{id:f(),type:"pawn",color:"black",image:"black_pawn1.png",dragImage:"black_pawn1_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn2.png",dragImage:"black_pawn2_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn3.png",dragImage:"black_pawn3_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn4.png",dragImage:"black_pawn4_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn5.png",dragImage:"black_pawn5_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn6.png",dragImage:"black_pawn6_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn7.png",dragImage:"black_pawn7_drag.png"},{id:f(),type:"pawn",color:"black",image:"black_pawn8.png",dragImage:"black_pawn8_drag.png"}],Array(8).fill(null),Array(8).fill(null),Array(8).fill(null),Array(8).fill(null),[{id:f(),type:"pawn",color:"white",image:"white_pawn1.png",dragImage:"white_pawn1_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn2.png",dragImage:"white_pawn2_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn3.png",dragImage:"white_pawn3_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn4.png",dragImage:"white_pawn4_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn5.png",dragImage:"white_pawn5_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn6.png",dragImage:"white_pawn6_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn7.png",dragImage:"white_pawn7_drag.png"},{id:f(),type:"pawn",color:"white",image:"white_pawn8.png",dragImage:"white_pawn8_drag.png"}],[{id:f(),type:"rook",color:"white",image:"white_rook.png",dragImage:"white_rook_drag.png"},{id:f(),type:"knight",color:"white",image:"white_knight.png",dragImage:"white_knight_drag.png"},{id:f(),type:"bishop",color:"white",image:"white_bishop.png",dragImage:"white_bishop_drag.png"},{id:f(),type:"queen",color:"white",image:"white_queen.png",dragImage:"white_queen_drag.png"},{id:f(),type:"king",color:"white",image:"white_king.png",dragImage:"white_king_drag.png"},{id:f(),type:"bishop",color:"white",image:"white_bishop2.png",dragImage:"white_bishop2_drag.png"},{id:f(),type:"knight",color:"white",image:"white_knight2.png",dragImage:"white_knight2_drag.png"},{id:f(),type:"rook",color:"white",image:"white_rook2.png",dragImage:"white_rook2_drag.png"}]];function F(n){const e=Math.floor(n/60),t=n%60;return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function X(n,e){const t=document.createElement("div");t.id="black-timer",t.className="timer-box";const o=document.createElement("div");if(o.id="white-timer",o.className="timer-box",!document.getElementById("timers-style")){const s=document.createElement("style");s.id="timers-style",s.textContent=`
      .timer-box {
        position: fixed;
        right: 10px;
        width: auto;
        min-width: 100px;
        max-width: 160px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-family: monospace;
        font-size: 1.3rem;
        padding: 10px 14px;
        border-radius: 8px;
        text-align: right;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 0 8px rgba(0,0,0,0.4);
        user-select: none;
      }

      #black-timer {
        top: 10px;
      }

      #white-timer {
        bottom: 10px;
      }

      #board-holder {
        margin-top: 80px;
        margin-bottom: 80px;
      }

      @media (max-width: 500px) {
        .timer-box {
          font-size: 1rem;
          padding: 8px 10px;
          min-width: 80px;
        }
      }
    `,document.head.appendChild(s)}document.body.appendChild(t),document.body.appendChild(o);function r(){t.textContent=F(e.getTime("black")),o.textContent=F(e.getTime("white")),requestAnimationFrame(r)}r()}const Y={"no-time":{base:1/0,increment:0},blitz:{base:3*60,increment:2},rapid:{base:10*60,increment:5},classic:{base:15*60,increment:0}};class Z{constructor(e,t){w(this,"whiteTime");w(this,"blackTime");w(this,"activeColor","white");w(this,"intervalId",null);w(this,"increment");w(this,"updateCallback",null);this.control=e,this.onTimeout=t;const{base:o,increment:r}=Y[e];this.whiteTime=o,this.blackTime=o,this.increment=r}setUpdateCallback(e){this.updateCallback=e}startTurn(e){this.stop(),this.activeColor=e,this.control!=="no-time"&&(this.intervalId=window.setInterval(()=>{var t;this.activeColor==="white"?this.whiteTime--:this.blackTime--,(t=this.updateCallback)==null||t.call(this),this.getTime(e)<=0&&(this.stop(),this.onTimeout(e))},1e3))}stop(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null)}addIncrement(e){this.increment>0&&this.control!=="no-time"&&(e==="white"?this.whiteTime+=this.increment:this.blackTime+=this.increment)}getTime(e){return e==="white"?this.whiteTime:this.blackTime}formatTime(e){if(e===1/0)return"∞";const t=Math.floor(e/60).toString().padStart(2,"0"),o=Math.floor(e%60).toString().padStart(2,"0");return`${t}:${o}`}getFormattedTime(e){return this.formatTime(this.getTime(e))}getActiveColor(){return this.activeColor}reset(){this.stop();const{base:e}=Y[this.control];this.whiteTime=e,this.blackTime=e,this.activeColor="white"}}let x=new Z("classic",()=>{});function pe(n){x=n}const ue={white:[[{from:{row:6,col:4},to:{row:4,col:4}},{from:{row:7,col:6},to:{row:5,col:5}}],[{from:{row:6,col:3},to:{row:4,col:3}},{from:{row:7,col:1},to:{row:5,col:2}}]],black:[[{from:{row:1,col:4},to:{row:3,col:4}},{from:{row:0,col:6},to:{row:2,col:5}}],[{from:{row:1,col:3},to:{row:3,col:3}},{from:{row:0,col:1},to:{row:2,col:2}}]]};function ee(n,e,t){if(t){const d=t.getCurrentTurn();if(!t.hasAnyLegalMove(d)&&t.isInCheck(d))return d!==e?1e4:-1e4;if(!t.hasAnyLegalMove(d)&&!t.isInCheck(d))return 0}const o={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100};let r=0,s=0,c=null;for(let d=0;d<8;d++)for(let l=0;l<8;l++){const p=n[d][l];if(p){const u=o[p.type];r+=p.color===e?u:-u,s++,p.type==="king"&&p.color!==e&&(c={row:d,col:l})}}if(t){const d=q(t).length,l=t.getCurrentTurn();t.currentTurn=l==="white"?"black":"white";const p=q(t).length;t.currentTurn=l,r+=.1*(d-p)}if(s<=5&&c){const l=Math.min(...[{row:0,col:0},{row:0,col:7},{row:7,col:0},{row:7,col:7}].map(p=>Math.abs(p.row-c.row)+Math.abs(p.col-c.col)));r+=(14-l)*.5}return r+=Math.random()*.01,r}function q(n){const e=n.getBoard(),t=n.getCurrentTurn(),o=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++){const c=e[r][s];if(c&&c.color===t){const d={row:r,col:s};for(const l of n.getLegalMoves(d))o.push({from:d,to:l})}}return o}function N(n,e,t,o){if(e===0||q(n).length===0)return ee(n.getBoard(),o,n);const r=q(n);if(t){let s=-1/0;for(const c of r){const d=n.clone();d.makeMove(c.from,c.to);const l=N(d,e-1,!1,o);s=Math.max(s,l)}return s}else{let s=1/0;for(const c of r){const d=n.clone();d.makeMove(c.from,c.to);const l=N(d,e-1,!0,o);s=Math.min(s,l)}return s}}function U(n,e,t,o,r,s){if(e===0||q(n).length===0)return ee(n.getBoard(),s,n);const c=q(n);if(r){let d=-1/0;for(const l of c){const p=n.clone();if(p.makeMove(l.from,l.to),d=Math.max(d,U(p,e-1,t,o,!1,s)),t=Math.max(t,d),t>=o)break}return d}else{let d=1/0;for(const l of c){const p=n.clone();if(p.makeMove(l.from,l.to),d=Math.min(d,U(p,e-1,t,o,!0,s)),o=Math.min(o,d),o<=t)break}return d}}function he(n,e){var m;const t=n.getBoard(),o=n.getCurrentTurn(),r=[];for(let a=0;a<8;a++)for(let i=0;i<8;i++){const g=t[a][i];if(g&&g.color===o){const h={row:a,col:i};for(const y of n.getLegalMoves(h)){const k=t[y.row][y.col];r.push({from:h,to:y,capture:!!k})}}}if(r.length===0)return null;const s=((m=n.getMoveHistory)==null?void 0:m.call(n).length)??0;if(e!=="easy"&&s<4){const a=ue[o],g=a[Math.floor(Math.random()*a.length)][s/2];if(g&&n.getLegalMoves(g.from).some(h=>h.row===g.to.row&&h.col===g.to.col)){const h=n.makeMove(g.from,g.to),y=t[g.to.row][g.to.col];return h?{from:g.from,to:g.to,capture:!!y}:null}}for(const a of r){const i=n.clone();i.makeMove(a.from,a.to);const g=i.getCurrentTurn();if(!i.hasAnyLegalMove(g)&&i.isInCheck(g))return n.makeMove(a.from,a.to)?{from:a.from,to:a.to,capture:a.capture,checkmate:!0}:null}let c=[],d=-1/0;if(e==="easy"){const a=r.filter(i=>i.capture);c=a.length>0?[a[Math.floor(Math.random()*a.length)]]:[r[Math.floor(Math.random()*r.length)]]}else{const a=e==="medium"?1:2;for(const i of r){const g=n.clone();g.makeMove(i.from,i.to);const h=e==="medium"?N(g,a-1,!1,o):U(g,a-1,-1/0,1/0,!1,o);h>d?(d=h,c=[i]):h===d&&c.push(i)}}const l=c[Math.floor(Math.random()*c.length)],p=n.makeMove(l.from,l.to),u=n.getCurrentTurn(),b=!n.hasAnyLegalMove(u)&&n.isInCheck(u);return p?{from:l.from,to:l.to,capture:l.capture,checkmate:b}:null}function H(n,e,t){const o=document.getElementById("app"),r=document.createElement("div");r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.display="flex",r.style.flexDirection="column",r.style.justifyContent="center",r.style.alignItems="center",r.style.zIndex="9999",r.style.animation="fadeIn 0.5s ease";let s="linear-gradient(to bottom right, rgba(0,0,0,0.8), rgba(30,30,30,0.9))";n.toLowerCase().includes("white")?s="linear-gradient(to bottom right, rgba(255,255,255,0.8), rgba(200,200,200,0.9))":n.toLowerCase().includes("black")?s="linear-gradient(to bottom right, rgba(0,0,0,0.8), rgba(20,20,20,0.95))":s="linear-gradient(to bottom right, rgba(100,100,100,0.8), rgba(60,60,60,0.9))",r.style.background=s;const c=document.createElement("div");c.style.backgroundColor="#fff",c.style.padding="40px",c.style.borderRadius="15px",c.style.boxShadow="0 0 25px rgba(255, 255, 255, 0.1)",c.style.textAlign="center",c.style.animation="popUp 0.5s ease",c.style.maxWidth="90%",c.style.minWidth="300px";const d=document.createElement("img");d.src="/logo.png",d.alt="Game Logo",d.style.width="80px",d.style.marginBottom="20px";const l=document.createElement("div");l.style.fontSize="3rem",l.style.marginBottom="10px";let p=new Audio,u=n;n.toLowerCase().includes("white")?(l.textContent="♔",l.style.color="#ddd",u=window.playerColor==="white"?"You Won!":"You Lost!",p=new Audio(window.playerColor==="white"?"/assets/sounds/victory.mp3":"/assets/sounds/defeat.mp3")):n.toLowerCase().includes("black")?(l.textContent="♚",l.style.color="#222",u=window.playerColor==="black"?"You Won!":"You Lost!",p=new Audio(window.playerColor==="black"?"/assets/sounds/victory.mp3":"/assets/sounds/defeat.mp3")):n.toLowerCase().includes("desconect")?(l.textContent="❌",l.style.color="#e74c3c",u="Your opponent disconnected.",p=new Audio("/assets/sounds/defeat.mp3")):(l.textContent="🤝",l.style.color="#888",u="Draw!",p=new Audio("/assets/sounds/draw.mp3")),p.play().catch(console.error);const b=document.createElement("h2");b.textContent=u,b.style.margin="0",b.style.fontSize="2rem",b.style.color="#333";const m=document.createElement("div");m.style.marginTop="25px",m.style.display="flex",m.style.justifyContent="center",m.style.gap="15px",m.style.flexWrap="wrap";const a=document.createElement("button");a.textContent="Play Again",a.style.padding="12px 25px",a.style.fontSize="1rem",a.style.cursor="pointer",a.style.backgroundColor="#444",a.style.color="white",a.style.border="none",a.style.borderRadius="8px",a.style.transition="background-color 0.3s",a.tabIndex=0,a.onmouseenter=()=>a.style.backgroundColor="#666",a.onmouseleave=()=>a.style.backgroundColor="#444",a.onclick=()=>{r.remove(),W(),e()};const i=document.createElement("button");if(i.textContent="Main Menu",i.style.padding="12px 25px",i.style.fontSize="1rem",i.style.cursor="pointer",i.style.backgroundColor="#222",i.style.color="white",i.style.border="none",i.style.borderRadius="8px",i.style.transition="background-color 0.3s",i.tabIndex=0,i.onmouseenter=()=>i.style.backgroundColor="#444",i.onmouseleave=()=>i.style.backgroundColor="#222",i.onclick=()=>{r.remove(),W(),t()},!document.getElementById("gameover-modal-style")){const h=document.createElement("style");h.id="gameover-modal-style",h.innerHTML=`
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes popUp {
        0% { transform: scale(0.6); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
    `,document.head.appendChild(h)}m.appendChild(a),m.appendChild(i),c.appendChild(d),c.appendChild(l),c.appendChild(b),c.appendChild(m),r.appendChild(c),o.appendChild(r);const g=h=>{h.key==="Escape"&&(r.remove(),W(),t(),window.removeEventListener("keydown",g))};window.addEventListener("keydown",g)}class ge{constructor(){w(this,"config",null)}setConfig(e){this.config=e,window.playerColor=e.playerColor}getConfig(){if(!this.config)throw new Error("Game configuration not set.");return this.config}getPlayerColor(){if(!this.config)throw new Error("Game configuration not set.");return this.config.playerColor}isAgainstAI(){var e;return((e=this.config)==null?void 0:e.mode)==="ai"}reset(){this.config=null,delete window.playerColor}}const S=new ge;function me(){const n=document.getElementById("app");n.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="20px",e.style.padding="40px";const t=document.createElement("h2");t.textContent="Select AI Difficulty",e.appendChild(t);const o=[{label:"🟢 Easy",value:"easy"},{label:"🟡 Medium",value:"medium"},{label:"🔴 Hard",value:"hard"}];let r="easy";for(const{label:l,value:p}of o){const u=document.createElement("button");u.textContent=l,u.style.padding="12px 24px",u.style.fontSize="1.1rem",u.style.cursor="pointer",u.style.width="220px",u.addEventListener("click",()=>{r=p,s()}),e.appendChild(u)}n.appendChild(e);function s(){e.innerHTML="";const l=document.createElement("h2");l.textContent="Who Starts?",e.appendChild(l);const p=document.createElement("button");p.textContent="You Start",c(p);const u=document.createElement("button");u.textContent="AI Starts",c(u),p.addEventListener("click",()=>{d(),S.setConfig({mode:"ai",playerColor:"white",aiLevel:r}),R()}),u.addEventListener("click",()=>{d(),S.setConfig({mode:"ai",playerColor:"black",aiLevel:r}),R()}),e.appendChild(p),e.appendChild(u)}function c(l){l.style.padding="12px 24px",l.style.fontSize="1.1rem",l.style.cursor="pointer",l.style.width="220px"}function d(){e.querySelectorAll("button").forEach(p=>p.disabled=!0)}}let T=null;function fe(){const n=document.getElementById("app");n.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.height="100vh",e.style.gap="20px";const t=document.createElement("p");t.textContent="Esperando a que el oponente acepte la invitación...",e.appendChild(t);const o=document.createElement("button");o.textContent="Cancelar",o.style.padding="10px 20px",o.style.fontSize="16px",o.style.cursor="pointer",o.onclick=()=>{v.getInstance().send({type:"error",message:"Invitación cancelada por el remitente."}),T&&(v.getInstance().off("join_response",T),T=null),_()},e.appendChild(o),n.appendChild(e),T&&v.getInstance().off("join_response",T),T=r=>{const s=r;if(s.accepted){const c=`${s.fromId}-${C.getInstance().getLocalId()}`;C.getInstance().setMatchId(c),console.log("[WaitingScreen] Invitación aceptada. Esperando inicio de partida desde el servidor.")}else alert("El oponente ha rechazado la invitación."),_();v.getInstance().off("join_response",T),T=null},v.getInstance().on("join_response",T)}function ye(){const n=document.getElementById("app");n.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.height="100vh",e.style.gap="20px";const t=document.createElement("h2");t.textContent="Conectar con otro jugador",e.appendChild(t);const o=document.createElement("p");o.id="local-id-display",o.style.fontWeight="bold",o.textContent="Tu ID: esperando...",e.appendChild(o);const r=C.getInstance().getLocalId();r&&(o.textContent=`Tu ID: ${r}`);const s=document.createElement("input");s.type="text",s.placeholder="Introduce el ID del oponente",s.id="opponent-id",s.name="opponent-id",s.style.padding="10px",s.style.fontSize="16px",s.style.width="250px",e.appendChild(s);const c=document.createElement("button");c.textContent="Enviar invitación",c.style.padding="10px 20px",c.style.fontSize="16px",c.style.cursor="pointer",e.appendChild(c);const d=document.createElement("p");d.style.color="red",e.appendChild(d),c.onclick=()=>{const l=s.value.trim(),p=C.getInstance().getLocalId();if(!l){d.textContent="Por favor, introduce un ID válido.";return}C.getInstance().setOpponentId(l);const u={type:"join_request",fromId:p,toId:l};v.getInstance().send(u),fe()},n.appendChild(e)}function _(){const n=document.getElementById("app");n.innerHTML="";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.gap="20px",e.style.padding="40px";const t=C.getInstance().getLocalId()||"(esperando ID...)",o=document.createElement("div");o.style.fontSize="1.1rem",o.style.marginBottom="10px",o.style.background="#f5f5f5",o.style.padding="8px 16px",o.style.borderRadius="8px",o.style.userSelect="all",o.textContent=`Tu ID: ${t}`,e.appendChild(o);const r=document.createElement("h2");r.textContent="Choose Game Mode",e.appendChild(r);const s=[{label:"Play vs AI",value:"ai"},{label:"Play with Friend (ID)",value:"id"},{label:"Random Opponent",value:"random"}];for(const{label:c,value:d}of s){const l=document.createElement("button");l.textContent=c,l.style.padding="12px 24px",l.style.fontSize="1.1rem",l.style.cursor="pointer",l.style.width="260px",l.addEventListener("click",()=>{if(W(),d==="ai")me();else if(d==="id")ye();else if(d==="random"){const p=C.getInstance().getLocalId();if(!p||p==="esperando"){alert("Esperando asignación de ID por el servidor. Intenta de nuevo en unos segundos.");return}v.getInstance().send({type:"find_random_opponent",id:p}),alert("Buscando oponente aleatorio...")}}),e.appendChild(l)}n.appendChild(e)}const M=new ce;let $=!0;function te(){const n=["rook","rook2","knight","knight2","bishop","bishop2","queen","king"],e=Array.from({length:8},(c,d)=>`pawn${d+1}`),t=[...n,...e],o=["white","black"],r=["","_drag","_check"];let s=document.getElementById("preload-pieces");s||(s=document.createElement("div"),s.id="preload-pieces",s.style.position="absolute",s.style.top="-9999px",s.style.left="-9999px",document.body.appendChild(s));for(const c of o)for(const d of t)for(const l of r){if(l==="_check"&&d!=="king")continue;const p=`${c}_${d}${l}.png`;if(!document.getElementById(p)){const u=new Image;u.id=p,u.src=`/assets/pieces/${p}`,u.style.width="1px",u.style.height="1px",u.onload=()=>console.log(`Imagen precargada: ${p}`),u.onerror=()=>console.warn(`No se pudo cargar: ${p}`),s.appendChild(u)}}}te();function R(){const n=document.getElementById("app");n.innerHTML="";let e=document.getElementById("board-holder");e||(e=document.createElement("div"),e.id="board-holder",n.appendChild(e)),te();const t=S.getConfig();let o;t.mode==="online"?o=Ie():o=new O(V),X(n,x),D(o,o.getBoard()),$=t.mode!=="ai"||t.playerColor==="white",x.startTurn(o.getCurrentTurn()),t.mode==="ai"&&t.playerColor==="black"&&setTimeout(()=>oe(o),500)}function D(n,e){if(!n){console.error("Engine is not initialized. Call showBoard() first.");return}let t=document.getElementById("board-holder");if(!t){const l=document.getElementById("app");if(!l){console.error("No se encontró el contenedor #app");return}t=document.createElement("div"),t.id="board-holder",l.appendChild(t)}const o=document.createElement("div");o.id="chess-board",o.style.display="grid",o.style.gridTemplateColumns="repeat(8, 1fr)",o.style.width="min(90vmin, 90vw)",o.style.height="min(90vmin, 90vw)",o.style.margin="auto",o.style.border="4px solid black",t.innerHTML="",t.appendChild(o);let r=null;const s=n.isInCheck("white"),c=n.isInCheck("black"),d=S.getConfig();for(let l=0;l<8;l++)for(let p=0;p<8;p++){const u=document.createElement("div"),b=(l+p)%2===0;u.style.backgroundColor=b?"#c2b280":"#6f4e37",u.style.width="100%",u.style.height="100%",u.style.position="relative";const m=e[l][p];if(m){const a=document.createElement("img"),i=m.type==="king"&&(m.color==="white"&&s||m.color==="black"&&c);i&&u.classList.add("in-check");const g=i?`${m.color}_king_check.png`:m.image;a.src=`/assets/pieces/${g}`,a.dataset.defaultSrc=m.image,a.dataset.dragSrc=i?`${m.color}_king_check.png`:m.dragImage||m.image,a.style.width="100%",a.style.height="100%",a.style.objectFit="contain",a.draggable=!1,u.draggable=!0,u.addEventListener("dragstart",h=>{if(d.mode==="online"&&!Q()){h.preventDefault();return}const y=n.getBoard()[l][p];if(!$||!y||y.color!==d.playerColor){h.preventDefault();return}a.src=`/assets/pieces/${a.dataset.dragSrc}`,setTimeout(()=>{a.style.visibility="hidden"},0),r={row:l,col:p}}),u.addEventListener("dragend",()=>{m.type==="king"&&(m.color==="white"&&n.isInCheck("white")||m.color==="black"&&n.isInCheck("black"))?a.src=`/assets/pieces/${m.color}_king_check.png`:a.src=`/assets/pieces/${a.dataset.defaultSrc}`,a.style.visibility="visible",M.play("drag")}),u.appendChild(a)}u.addEventListener("dragover",a=>a.preventDefault()),u.addEventListener("drop",()=>{if(d.mode==="online"&&!Q()){M.play("error");return}if(!r||!$)return;const a={row:l,col:p},g=n.getBoard()[a.row][a.col]!==null;if(n.makeMove(r,a)){$=!1,g&&M.play("capture");const y=n.getCurrentTurn()==="white"?"black":"white";x.addIncrement(y),x.startTurn(n.getCurrentTurn()),n.isInCheck(n.getCurrentTurn())&&M.play("check"),D(n,n.getBoard());const k=n.getCurrentTurn(),I=d.playerColor,E=n.isInCheck(k)&&k===I,j=n.isInCheck(k)&&k!==I,ne=!n.isInCheck(k);let z="";if(!n.hasAnyLegalMove(k)){E?z="¡Has perdido! (Jaque mate)":j?z="¡Has ganado! (Jaque mate)":ne&&(z="Tablas (ahogado)"),H(z,()=>R(),()=>_());return}d.mode==="online"&&ke(r,a),d.mode==="ai"&&n.getCurrentTurn()!==d.playerColor?setTimeout(()=>oe(n),1e3):$=!0}r=null}),o.appendChild(u)}}function oe(n){const e=S.getConfig();if(!e.aiLevel){console.error("AI difficulty level is not set."),H("AI configuration error. Returning to main menu.",()=>{_()},()=>{_()});return}const t=n.getBoard().map(p=>p.map(u=>u?{...u}:null)),o=he(n,e.aiLevel);if(!o){const p=n.getCurrentTurn(),u=e.playerColor,b=n.isInCheck(p)&&p===u,m=n.isInCheck(p)&&p!==u,a=!n.isInCheck(p);let i="";b?i="¡Has perdido! (Jaque mate)":m?i="¡Has ganado! (Jaque mate)":a&&(i="Tablas (ahogado)"),H(i,()=>R(),()=>_());return}if(o.checkmate){const u=(n.getCurrentTurn()==="white"?"black":"white")===e.playerColor?"¡Has ganado! (Jaque mate)":"¡Has perdido! (Jaque mate)";setTimeout(()=>{H(u,()=>R(),()=>_())},300);return}const r=document.getElementById("chess-board");if(r){const p=o.from.row*8+o.from.col,u=o.to.row*8+o.to.col,b=r.children[p],m=r.children[u],a=b==null?void 0:b.querySelector("img");if(a&&m){a.dataset.dragSrc&&(a.src=`/assets/pieces/${a.dataset.dragSrc}`),M.play("drag"),setTimeout(()=>{const i=a.getBoundingClientRect(),g=m.getBoundingClientRect(),h=a.cloneNode(!0);h.style.position="fixed",h.style.left=`${i.left}px`,h.style.top=`${i.top}px`,h.style.width=`${i.width}px`,h.style.height=`${i.height}px`,h.style.pointerEvents="none",h.style.transition="left 0.4s linear, top 0.4s linear, opacity 0.1s",document.body.appendChild(h),a.style.visibility="hidden",setTimeout(()=>{h.style.left=`${g.left}px`,h.style.top=`${g.top}px`},10),setTimeout(()=>{h.style.opacity="0",setTimeout(()=>{document.body.removeChild(h),a.dataset.defaultSrc&&(a.src=`/assets/pieces/${a.dataset.defaultSrc}`),a.style.visibility="visible";const k=t[o.to.row][o.to.col]!==null;n.makeMove(o.from,o.to),k?M.play("capture"):M.play("move");const I=n.getCurrentTurn(),E=I==="white"?"black":"white";x.addIncrement(E),x.startTurn(I),n.isInCheck(I)&&M.play("check"),D(n,n.getBoard()),$=!0},100)},410)},200);return}}n.makeMove(o.from,o.to),n.getBoard();const s=t[o.to.row][o.to.col];s!==null&&s.color!==n.getCurrentTurn()?M.play("capture"):M.play("move");const d=n.getCurrentTurn(),l=d==="white"?"black":"white";x.addIncrement(l),x.startTurn(d),n.isInCheck(d)&&M.play("check"),D(n,n.getBoard()),console.log("AI move executed:",o),$=!0}let L,P=!1,J=!1;function we(n){if(console.log("[RemoteGame] startRemoteGame ejecutado",n),J){console.warn("[RemoteGame] La partida remota ya ha sido iniciada.");return}J=!0;const e=document.getElementById("app"),t=document.createElement("div");t.id="board-holder",e&&(e.innerHTML="",e.appendChild(t));const o=C.getInstance().getLocalId();if(!o){console.error("[RemoteGame] ERROR: El ID local no está asignado antes de iniciar la partida.");return}const r=n.whiteId===o?"white":"black";console.log(`[RemoteGame] Mi ID: ${o}, White: ${n.whiteId}, Black: ${n.blackId}, Mi color: ${r}`),console.log("[RemoteGame] Inicializando engine"),L=new O(V),S.setConfig({mode:"online",playerColor:r}),P=r==="white",pe(new Z("classic",s=>{const d=S.getConfig().playerColor;H(s===d?"¡Has perdido por tiempo!":"¡Has ganado por tiempo!",()=>_(),()=>_())})),x.reset(),P&&x.startTurn(r),X(t,x),console.log("[Board] renderBoard llamado",L),D(L,L.getBoard())}function be(n){const e=S.getConfig();if(n.playerId===C.getInstance().getLocalId())return;L.makeMove(n.from,n.to)&&(D(L,L.getBoard()),x.addIncrement(e.playerColor),x.startTurn(e.playerColor),P=!0)}function ke(n,e){const t={type:"move",from:n,to:e,playerId:C.getInstance().getLocalId()};v.getInstance().send(t),P=!1}function Ie(){return L}function Q(){return P}function W(){J=!1}console.log("[Client] initWebSocketListeners ejecutado");let K=!1;function Ce(){if(console.log("[Client] initWebSocketListeners ejecutado"),K)return;K=!0;const n=v.getInstance();n.on("join_request",e=>{console.log("[Listener] join_request recibido",e),ae(e)}),n.on("start_game",e=>{console.log("[Listener] start_game recibido",e),we(e)}),n.on("join_response",e=>{e.accepted||(alert("El jugador rechazó la invitación o ya está en partida."),_())}),n.on("opponent_disconnected",e=>{"playerId"in e&&(alert("Tu oponente se ha desconectado."),_())}),n.on("init",e=>{const t=e;t.id!=="esperando"?(localStorage.setItem("playerId",t.id),C.getInstance().setLocalId(t.id),console.log("[Client] Received ID from server and stored:",t.id),_()):console.warn('[Client] ID "esperando" no se guarda en localStorage')}),n.on("move",e=>{be(e)})}console.log("Starting Chess Game Client...");Ce();const ve=location.hostname==="localhost"?"ws://localhost:3000":"wss://cheess-game.onrender.com";v.getInstance().connect(ve);
